<!DOCTYPE html>

<html>

<head>

    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>

</head>

<body>

    <script>

        var config = {
            type: Phaser.AUTO,
            width: 1200,
            height: 700,
            physics: {
                default: 'arcade',
            },

            scene: {
                preload: preload,
                create: create,
                update: update,
            }

        };

        class PlayerBulletGroup extends Phaser.Physics.Arcade.Group {
            constructor(scene) {
                super(scene.physics.world, scene);

                // Initialize the group
                this.createMultiple({
                    classType: PlayerBullet, // This is the class we create just below
                    frameQuantity: 30, // Create 30 instances in the pool
                    active: false,
                    visible: false,
                    key: 'playerBullet'
                })
            }

            fireBullet(x, y) {
                // Get the first available sprite in the group
                const bullet = this.getFirstDead(false);
                if (bullet) {
                    bullet.fire(x, y);
                }
            }
        }

        class PlayerBullet extends Phaser.Physics.Arcade.Sprite {
            constructor(scene, x, y) {
                super(scene, x, y, 'playerBullet');
            }          

            preUpdate(time, delta) { // before the game updates physics
                super.preUpdate(time, delta);

                if (this.y <= 0 || this.y >= game.height || this.x <= 0 || this.x >= game.width) {
                    this.setActive(false);
                    this.setVisible(false);
                    console.log("Bullet Killed")
                }
            }

            fire(x, y) {
                this.body.reset(x, y);

                this.setActive(true);
                this.setVisible(true);

                this.setVelocityX(900);
            }
        }

        class Player extends Phaser.Physics.Arcade.Sprite {
            accelerationFactor = 500
            turnAcceleration = 1000
            turnRate = 145
            movementSpeed = 500
            maxMovementSpeed = 500


            constructor(scene, x, y) {
                super(scene, x, y, 'player');
                scene.add.existing(this);
                scene.physics.add.existing(this);
                this.setCollideWorldBounds(true);

                this.setDamping(true)
                this.setDrag(1.25, 1.25)
                this.setAngularDrag(100)
                this.setBounce(.5, .5)
            }
        }


        var game = new Phaser.Game(config);

        var player;

        var playerBulletGroup;
        console.log(playerBulletGroup)


        //Keyboard controls
        var cursors;
        var keys;
        var space;

        var gui;
        var guiTimer;

        function preload() {

        }

        function shootPlayerBullet() {
            playerBulletGroup.fireBullet(player.x, player.y)
        }

        function create() {
            playerBulletGroup = new PlayerBulletGroup(this);
            this.input.on('pointerdown', shootPlayerBullet)
           

            player = new Player(this, 400, 400);

            //Set up user input
            cursors = this.input.keyboard.createCursorKeys();
            keys = this.input.keyboard.addKeys('W, A, S, D');
            space = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
            space.on('down', onSpacePress);
        }

        function onSpacePress() {
            shootPlayerBullet()
        }


        function update(time, delta) {
            let deltaSeconds = delta / 1000
            let timeSeconds = time / 1000

            player.setAcceleration(0, 0)
            player.setAngularAcceleration(0)

            let playerMouseDelta = new Phaser.Math.Vector2(game.input.mousePointer.x - player.x, game.input.mousePointer.y - player.y)
            let playerLookVector = new Phaser.Math.Vector2(Math.cos(player.rotation), Math.sin(player.rotation))

            // player.setAngularVelocity(180 / Math.PI * (player.rotation - Math.atan(playerMouseDelta.y / playerMouseDelta.x)))

            player.setRotation(Math.atan(playerMouseDelta.y / playerMouseDelta.x))

            let movementVector = new Phaser.Math.Vector2(0, 0)

            if (keys.W.isDown) { movementVector.add(new Phaser.Math.Vector2(0, -1)) }
            if (keys.A.isDown) { movementVector.add(new Phaser.Math.Vector2(-1, 0)) }
            if (keys.S.isDown) { movementVector.add(new Phaser.Math.Vector2(0, 1)) }
            if (keys.D.isDown) { movementVector.add(new Phaser.Math.Vector2(1, 0)) }

            movementVector.normalize()

            player.setAcceleration(player.movementSpeed * movementVector.x, player.movementSpeed * movementVector.y)


        }

    </script>

</body>

</html>